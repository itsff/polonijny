<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="fancy-input.html">

<dom-module id="add-entry">
    <template>
        <section>
            <form role="form" on-submit="formSubmit">
                <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title">Hasło</div>
                        </div>
                        <div class="panel-body">
                            
                            <div class="form-group form-group-lg">
                                <label for="entry">Hasło (z małej, chyba że nazwa własna):</label>
                                <input type="text"
                                    value="{{entry::input}}"
                                    class="form-control input-lg"
                                    id="entry"
                                    placeholder="wpisz tutaj nowe hasło" />
                            </div>
                        </div>
                    </div>

                <fancy-input panel-title="Znaczenia"
                             add-text="Dodaj kolejne znaczenie"
                             placeholder="znaczenie"
                             items="{{meanings}}">
                    <div class="alert alert-warning" role="alert">
                        <strong>Psst</strong> - Hasło ma kilka znaczeń? Kliknij przycisk aby dodać więcej linijek.
                        Proszę podać każde znaczenie na osobnej linijce.
                    </div>
                </fancy-input>


                <fancy-input panel-title="Znaczenia angielskie"
                             add-text="Dodaj znaczenie angielskie "
                             placeholder="ang"
                             items="{{english}}">
                    <div class="alert alert-warning" role="alert">
                        <strong>Psst</strong> - Hasło ma kilka znaczeń? Kliknij przycisk aby dodać więcej linijek.
                        Proszę podać każde znaczenie na osobnej linijce.
                    </div>
                </fancy-input>


                <fancy-input panel-title="Przykłady"
                             add-text="Dodaj przykład"
                             placeholder="np"
                             items="{{examples}}">
                    <div class="alert alert-info" role="alert">
                        <strong>Psst</strong> - Chcesz dodać link to innego hasła? Napisz je w [nawiasach].
                        <p>
                            Np. <mark>[Kap]</mark> mi powiedział żebym nie stawiał <mark>[kary|kara]</mark> na <mark>[kornerze|korner]</mark>.
                        </p>
                    </div>
                    <div class="alert alert-warning" role="alert"> 
                        <p>
                            Jak chcesz dodać więcej niż jeden przykład, to naciśnij poniższy przycisk aby dodać więcej linijek.
                            <strong>Każda linijka powinna zawierać tylo jeden przykład</strong>.
                        </p>
                    </div>
                </fancy-input>

                <fancy-input panel-title="Hasła pokrewne"
                             add-text="Dodaj hasło pokrewne"
                             placeholder="zob. też"
                             items="{{see_also}}">
                    <div class="alert alert-warning" role="alert">
                        <p>
                            <strong>Psst</strong> - Kilka haseł pokrewnych? Kliknij przycisk aby dodać więcej linijek.
                            Proszę podać każde hasło na osobnej linijce.
                        </p>
                    </div>
                </fancy-input>

                <div class="form-group form-group-lg">
                    <div id="g-recaptcha"></div>
                </div>

                <template is="dom-if" if="{{error}}">
                    <div class="form-group form-group-lg">
                        <div id="error" class="alert alert-danger" role="alert">
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                            <span class="sr-only">Problem:</span>
                            <strong>Problem!</strong>&nbsp;<span>{{error}}</span>
                        </div>
                    </div>
                </template>


                <div class="form-group form-group-lg">
                    <button type="submit"
                            class="btn btn-success btn-lg"
                            id="submitButton">Dodaj hasło do słownika</button>
                </div>
            </form>
            <script type="text/javascript">
             var onloadCallback = function() {
                 grecaptcha.render('g-recaptcha', {
                     'sitekey' : '6LcpgQcTAAAAAFqGZbDtRKcBp7WIDi_UFARU1ihk',
                     'hl'      : 'pl'
                 });
             };
            </script>
            <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>
        </section>
    </template>
</dom-module>

<script>
 Polymer({
     is: "add-entry",

     ready: function() {

         this.entry = "";

         this.meanings = [];
         this.english  = [];
         this.examples = [];
         this.see_also = [];

         this.error    = "";
     },

     normalize_col: function(col) {
         var result = [];
         for (var i=0,  tot=col.length; i < tot; ++i) {

             var s = col[i].value.trim();
             if (s.length > 0)
             {
                 result.push(s);
             }
         }
         return result;
     },

     exportModel: function() {
         var payload = {
             'entry'    : this.entry.trim(),
             'meanings' : this.normalize_col(this.meanings),
             'english'  : this.normalize_col(this.english),
             'examples' : this.normalize_col(this.examples),
             'see_also' : this.normalize_col(this.see_also)
         };

         return payload;
     },

     formSubmit: function(e) {
         e.preventDefault();

         this.$$('#submitButton').disabled = true;

         console.log("submit!");
         var model = this.exportModel();
         model['g-recaptcha-response'] = $("#g-recaptcha-response").val();

         console.log(model);

         var self = this;

         var posting = $.ajax({
             type: "POST",
             url: "/dodaj",
             data: JSON.stringify(model),
             contentType: "application/json; charset=utf-8",
             dataType: "json"});
         posting.done(function(data, textStatus, jqXHR) {
             window.location.href = "/h/" + model['entry'];

         }).fail(function(jqXHR, textStatus, errorCode) {
             console.log(jqXHR.responseText)
             self.set('error', jqXHR.responseText);

         }).always(function() {
             self.$$('#submitButton').disabled = false;
             grecaptcha.reset();
         });
     }
 });
</script>
